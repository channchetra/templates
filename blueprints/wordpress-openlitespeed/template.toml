[variables]
main_domain = "${domain}"
db_name = "wordpress"
db_user = "wordpress"
db_password = "${password:32}"
db_root_password = "${password:64}"

[config]
env = [
  "DB_NAME=${db_name}",
  "DB_USER=${db_user}",
  "DB_PASSWORD=${db_password}",
  "DB_ROOT_PASSWORD=${db_root_password}",
  "WP_DEBUG=false"
]

[[config.domains]]
serviceName = "wordpress-openlitespeed"
port = 80
host = "${main_domain}"

[[config.mounts]]
filePath = "wp-entrypoint.sh"
content = """#!/bin/bash
set -e

# ---------------------------------------------------
# Restore default OLS config if volumes are empty
# ---------------------------------------------------
if [ -z "$(ls -A -- /usr/local/lsws/conf/)" ]; then
    cp -R /usr/local/lsws/.conf/* /usr/local/lsws/conf/
fi
if [ -z "$(ls -A -- /usr/local/lsws/admin/conf/)" ]; then
    cp -R /usr/local/lsws/admin/.conf/* /usr/local/lsws/admin/conf/
fi
chown 994:994 /usr/local/lsws/conf -R
chown 994:1001 /usr/local/lsws/admin/conf -R

WP_ROOT="/var/www/vhosts/localhost/html"

# ---------------------------------------------------
# Install WP-CLI if not present
# ---------------------------------------------------
if [ ! -f /usr/local/bin/wp ]; then
    echo "Installing WP-CLI..."
    curl -sO https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
    chmod +x wp-cli.phar
    mv wp-cli.phar /usr/local/bin/wp
    echo "WP-CLI installed."
fi
# Allow WP-CLI to run as root without --allow-root flag
mkdir -p /root/.wp-cli
cat > /root/.wp-cli/config.yml << 'WPCLIEOF'
path: /var/www/vhosts/localhost/html
apache_modules:
  - mod_rewrite
WPCLIEOF
export WP_CLI_ALLOW_ROOT=1

# ---------------------------------------------------
# Wait for MariaDB
# ---------------------------------------------------
echo "Waiting for MariaDB..."
COUNTER=0
while ! mysqladmin ping -h"${MYSQL_HOST}" --silent 2>/dev/null; do
    COUNTER=$((COUNTER+1))
    if [ ${COUNTER} -ge 60 ]; then
        echo "MariaDB connection timeout, continuing..."
        break
    fi
    sleep 2
done
echo "MariaDB is ready."

# ---------------------------------------------------
# Download WordPress if not present
# ---------------------------------------------------
if [ ! -f "${WP_ROOT}/wp-config.php" ] && [ ! -f "${WP_ROOT}/wp-config-sample.php" ]; then
    echo "Downloading WordPress..."
    mkdir -p "${WP_ROOT}"
    cd "${WP_ROOT}"
    wp core download --allow-root --quiet 2>/dev/null || {
        echo "WP-CLI failed, falling back to curl..."
        cd /tmp
        curl -sO https://wordpress.org/latest.tar.gz
        tar -xzf latest.tar.gz
        cp -a wordpress/. "${WP_ROOT}/"
        rm -rf latest.tar.gz wordpress
    }
    chown -R nobody:nogroup /var/www/vhosts/localhost
    echo "WordPress downloaded successfully."
fi

# ---------------------------------------------------
# Create wp-config.php
# ---------------------------------------------------
if [ ! -f "${WP_ROOT}/wp-config.php" ] && [ -f "${WP_ROOT}/wp-config-sample.php" ]; then
    echo "Creating wp-config.php..."
    cp "${WP_ROOT}/wp-config-sample.php" "${WP_ROOT}/wp-config.php"

    sed -i "s/database_name_here/${MYSQL_DATABASE}/" "${WP_ROOT}/wp-config.php"
    sed -i "s/username_here/${MYSQL_USER}/" "${WP_ROOT}/wp-config.php"
    sed -i "s/password_here/${MYSQL_PASSWORD}/" "${WP_ROOT}/wp-config.php"
    sed -i "s/localhost/${MYSQL_HOST}/" "${WP_ROOT}/wp-config.php"

    SALT=$(curl -sS https://api.wordpress.org/secret-key/1.1/salt/ 2>/dev/null)
    if [ -n "${SALT}" ]; then
        STRING='put your unique phrase here'
        printf '%s\\n' "g/${STRING}/d" a "${SALT}" . w | ed -s "${WP_ROOT}/wp-config.php" 2>/dev/null || true
    fi

    # Redis object cache
    sed -i "/\/\* That's all, stop editing/i define('WP_REDIS_HOST', '${REDIS_HOST}');" "${WP_ROOT}/wp-config.php"
    sed -i "/\/\* That's all, stop editing/i define('WP_REDIS_PORT', 6379);" "${WP_ROOT}/wp-config.php"

    # WordPress performance & security settings
    sed -i "/\/\* That's all, stop editing/i define('WP_MEMORY_LIMIT', '256M');" "${WP_ROOT}/wp-config.php"
    sed -i "/\/\* That's all, stop editing/i define('WP_MAX_MEMORY_LIMIT', '512M');" "${WP_ROOT}/wp-config.php"
    sed -i "/\/\* That's all, stop editing/i define('DISALLOW_FILE_EDIT', true);" "${WP_ROOT}/wp-config.php"
    sed -i "/\/\* That's all, stop editing/i define('WP_AUTO_UPDATE_CORE', 'minor');" "${WP_ROOT}/wp-config.php"
    sed -i "/\/\* That's all, stop editing/i define('WP_POST_REVISIONS', 10);" "${WP_ROOT}/wp-config.php"
    sed -i "/\/\* That's all, stop editing/i define('AUTOSAVE_INTERVAL', 120);" "${WP_ROOT}/wp-config.php"
    sed -i "/\/\* That's all, stop editing/i define('EMPTY_TRASH_DAYS', 15);" "${WP_ROOT}/wp-config.php"

    # WordPress debug settings (controlled by WP_DEBUG env var)
    if [ "${WP_DEBUG}" = "true" ]; then
        sed -i "s/define( *'WP_DEBUG'.*/define('WP_DEBUG', true);/" "${WP_ROOT}/wp-config.php"
        sed -i "/\/\* That's all, stop editing/i define('WP_DEBUG_LOG', true);" "${WP_ROOT}/wp-config.php"
        sed -i "/\/\* That's all, stop editing/i define('WP_DEBUG_DISPLAY', false);" "${WP_ROOT}/wp-config.php"
        sed -i "/\/\* That's all, stop editing/i define('SCRIPT_DEBUG', true);" "${WP_ROOT}/wp-config.php"
        echo "WP_DEBUG enabled (logs to wp-content/debug.log)."
    fi

    # Reverse proxy support (Dokploy/Traefik) - must be BEFORE wp-settings.php loads
    cat > "${WP_ROOT}/wp-proxy-config.php" << 'PROXYEOF'
<?php
/** Reverse proxy / Traefik support */
if (isset($_SERVER['HTTP_X_FORWARDED_PROTO']) && $_SERVER['HTTP_X_FORWARDED_PROTO'] === 'https') {
    $_SERVER['HTTPS'] = 'on';
}
if (isset($_SERVER['HTTP_X_FORWARDED_HOST'])) {
    $_SERVER['HTTP_HOST'] = $_SERVER['HTTP_X_FORWARDED_HOST'];
}
if (isset($_SERVER['HTTP_X_REAL_IP'])) {
    $_SERVER['REMOTE_ADDR'] = $_SERVER['HTTP_X_REAL_IP'];
}
define('FORCE_SSL_ADMIN', false);
PROXYEOF
    chown nobody:nogroup "${WP_ROOT}/wp-proxy-config.php"
    sed -i "/\/\* That's all, stop editing/i require_once(__DIR__ . '\/wp-proxy-config.php');" "${WP_ROOT}/wp-config.php"

    chown nobody:nogroup "${WP_ROOT}/wp-config.php"
    echo "wp-config.php configured."
fi

# ---------------------------------------------------
# Create .htaccess for WordPress permalinks & REST API
# ---------------------------------------------------
if [ ! -f "${WP_ROOT}/.htaccess" ]; then
    cat > "${WP_ROOT}/.htaccess" << 'HTEOF'
# BEGIN WordPress
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]
RewriteBase /
RewriteRule ^index\.php$ - [L]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule . /index.php [L]
</IfModule>
# END WordPress
HTEOF
    chown nobody:nogroup "${WP_ROOT}/.htaccess"
    echo ".htaccess created."
fi

# ---------------------------------------------------
# Patch existing wp-config.php for reverse proxy
# (runs on restarts for already-deployed sites)
# ---------------------------------------------------
if [ ! -f "${WP_ROOT}/wp-proxy-config.php" ]; then
    cat > "${WP_ROOT}/wp-proxy-config.php" << 'PROXYEOF'
<?php
/** Reverse proxy / Traefik support */
if (isset($_SERVER['HTTP_X_FORWARDED_PROTO']) && $_SERVER['HTTP_X_FORWARDED_PROTO'] === 'https') {
    $_SERVER['HTTPS'] = 'on';
}
if (isset($_SERVER['HTTP_X_FORWARDED_HOST'])) {
    $_SERVER['HTTP_HOST'] = $_SERVER['HTTP_X_FORWARDED_HOST'];
}
if (isset($_SERVER['HTTP_X_REAL_IP'])) {
    $_SERVER['REMOTE_ADDR'] = $_SERVER['HTTP_X_REAL_IP'];
}
define('FORCE_SSL_ADMIN', false);
PROXYEOF
    chown nobody:nogroup "${WP_ROOT}/wp-proxy-config.php"
    echo "Created wp-proxy-config.php."
fi
if [ -f "${WP_ROOT}/wp-config.php" ] && ! grep -q 'wp-proxy-config.php' "${WP_ROOT}/wp-config.php" 2>/dev/null; then
    sed -i "/\/\* That's all, stop editing/i require_once(__DIR__ . '\/wp-proxy-config.php');" "${WP_ROOT}/wp-config.php"
    chown nobody:nogroup "${WP_ROOT}/wp-config.php"
    echo "Patched existing wp-config.php with proxy config include."
fi

# ---------------------------------------------------
# Configure LiteSpeed Cache for Redis object cache
# ---------------------------------------------------
LSC_CONST="${WP_ROOT}/wp-content/plugins/litespeed-cache/data/const.default.json"
if [ -f "${LSC_CONST}" ]; then
    sed -i 's/"object": .*"/"object": "true"/' "${LSC_CONST}"
    sed -i 's/"object-kind": .*"/"object-kind": "true"/' "${LSC_CONST}"
    sed -i 's/"object-host": .*"/"object-host": "redis"/' "${LSC_CONST}"
    sed -i 's/"object-port": .*"/"object-port": "6379"/' "${LSC_CONST}"
    echo "LiteSpeed Cache configured for Redis."
fi

# ---------------------------------------------------
# Start OpenLiteSpeed
# ---------------------------------------------------
echo "Starting OpenLiteSpeed..."
/usr/local/lsws/bin/lswsctrl start
"$@"

while true; do
    if ! /usr/local/lsws/bin/lswsctrl status | /usr/bin/grep 'litespeed is running with PID *' > /dev/null; then
        break
    fi
    sleep 60
done
"""
